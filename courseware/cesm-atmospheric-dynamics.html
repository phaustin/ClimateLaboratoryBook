
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>23. Atmospheric Dynamics in the CESM &#8212; Climate Laboratory Book</title>
    
  <link rel="stylesheet" href="../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.c441f2ba0852f4cabcb80105e3a46ae6.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.7d483ff0a819d6edff12ce0b1ead3928.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <link rel="canonical" href="https://phaustin.github.io/ClimateLaboratoryBook/courseware/cesm-atmospheric-dynamics.html" />
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="24. A peek at numerical methods for diffusion models" href="numerical-diffusion.html" />
    <link rel="prev" title="22. Modeling the seasonal cycle of surface temperature" href="seasonal-cycle.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />


<!-- Opengraph tags -->
<meta property="og:url"         content="https://phaustin.github.io/ClimateLaboratoryBook/courseware/cesm-atmospheric-dynamics.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Atmospheric Dynamics in the CESM" />
<meta property="og:description" content="Atmospheric Dynamics in the CESM  This notebook is an extension of The Climate Laboratory by Brian E. J. Rose, University at Albany. Notebook by Rachel H. White" />


<meta name="twitter:card" content="summary" />


  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  
  <h1 class="site-logo" id="site-title">Climate Laboratory Book</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../home.html">
   The Climate Laboratory
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Syllabus
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../syllabus.html">
   Course structure and Outline
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Front matter
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../preamble.html">
   Preamble
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../about.html">
   About this Book
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../who-for.html">
   Who is the book for?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../how-to.html">
   How to use this book
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../attribution.html">
   How to cite and reuse this material
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../extra_reading.html">
   Additional resources
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Lectures
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="models-budgets-fun.html">
   1. Climate models, the global energy budget, and Fun with Python
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="zero-dim-ebm.html">
   2. Modeling the global energy budget
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="analytical-efolding.html">
     2.10.1. Advanced topic: Analytical solution of the global Energy Balance Model
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="climate-system-models.html">
   3. The climate system and climate models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="introducing-cesm.html">
   4. Introducing the Community Earth System Model (CESM)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="climlab-intro.html">
   5. Building simple climate models using climlab
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="radiation.html">
   6. A Brief Review of Radiation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="elementary-greenhouse.html">
   7. Elementary greenhouse models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sympy-greenhouse.html">
   8. Advanced topic: Solving the two-layer grey gas model analytically with sympy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="grey-radiation-climlab.html">
   9. Grey radiation modeling with climlab
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="radiative-transfer.html">
   10. Modeling non-scattering radiative transfer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="spectral-bands.html">
   11. Who needs spectral bands? We do. Some baby steps…
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="radeq.html">
   12. Radiative Equilibrium
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rce.html">
   13. Radiative-Convective Equilibrium
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="sensitivity-feedback.html">
   14. Climate sensitivity and feedback
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="advanced-sensitivity-feedback.html">
     14.8.1. Advanced topic: Climate sensitivity and feedback
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="transient-cesm.html">
   15. Examing the transient and equilibrium CO
   <span class="math notranslate nohighlight">
    \(_2\)
   </span>
   response in the CESM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="transient-toy.html">
   16. Toy models of transient warming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="clouds.html">
   17. Clouds and cloud feedback
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="insolation.html">
   18. Insolation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="orbital.html">
   19. Orbital variations, insolation, and the ice ages
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="heat-transport.html">
   20. Heat transport
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="advanced-heat-transport.html">
     20.7.1. Advanced topic: Heat transport decomposition
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="one-dim-ebm.html">
   21. The one-dimensional energy balance model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="seasonal-cycle.html">
   22. Modeling the seasonal cycle of surface temperature
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   23. Atmospheric Dynamics in the CESM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numerical-diffusion.html">
   24. A peek at numerical methods for diffusion models
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="albedo-snowball.html">
   25. Ice-albedo feedback and Snowball Earth in the EBM
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="advanced-albedo-feedback.html">
     25.9.1. Advanced topic: Ice albedo feedback in the EBM – test2
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="advanced-snowball-earth.html">
     25.9.2. Advanced topic: Snowball Earth and Large Ice Cap Instability in the EBM
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cesm-coupled-dynamics.html">
   26. Coupled Dynamics in the CESM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="surface-energy-balance.html">
   27. The surface energy balance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="land-ocean-contrast.html">
   28. Land-Ocean contrasts under climate change
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="water-water-everywhere.html">
   29. Water, water everywhere!
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Assignments
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../about-assignments.html">
   About the assignments
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="assignment-zero-dim-ebm.html">
   Assignment: Climate change in the zero-dimensional EBM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="assignment-cesm-control.html">
   Assignment: Global average budgets in the CESM pre-industrial control simulation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="assignment-cesm-control-hints.html">
   Additional hints and guidance for CESM budgets assignment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="assignment-simple-clouds.html">
   Assignment: Clouds in the Leaky Greenhouse Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="assignment-rcm-feedback.html">
   Assignment: Feedbacks in the Radiative-Convective Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="assignment-cesm-climate-change.html">
   Assignment: Climate change in the CESM simulations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="assignment-insolation-orbit.html">
   Assignment: Insolation and orbital parameters
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Extra notebooks
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="hydrostat.html">
   Hydrostatic balance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="hydrostatic_balance.html">
   Scale heights for typical atmospheric soundings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="hydrostatic_balance.html#use-pd-dataframe-head-to-see-first-5-lines">
   Use pd.DataFrame.head to see first 5 lines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="multi_layer_equilibrium.html">
   Radiative equilibrium
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="bayes_lecture.html">
   What I wish I’d known about statistics
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  References
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../references.html">
   References
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="../_sources/courseware/cesm-atmospheric-dynamics.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/courseware/cesm-atmospheric-dynamics.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->


            <!-- Full screen (wrap in <a> to have style consistency -->
            <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                    data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                    title="Fullscreen mode"><i
                        class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/phaustin/ClimateLaboratoryBook/jb?urlpath=tree/content/courseware/cesm-atmospheric-dynamics.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        <a class="jupyterhub-button" href="https://jupyterhub.eoas.ubc.ca/hub/user-redirect/git-pull?repo=https://github.com/phaustin/ClimateLaboratoryBook&urlpath=tree/ClimateLaboratoryBook/content/courseware/cesm-atmospheric-dynamics.md&branch=jb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch JupyterHub" data-toggle="tooltip"
                data-placement="left"><img class="jupyterhub-button-logo"
                    src="../_static/images/logo_jupyterhub.svg"
                    alt="Interact on JupyterHub">JupyterHub</button></a>
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i>
            Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#about-the-cesm">
   23.1. About the CESM
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#key-components-of-cesm">
     23.1.1. Key components of CESM:
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#large-scale-circulation-in-the-cesm">
   23.2. Large-scale circulation in the CESM
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#zonal-mean-circulation">
     23.2.1. Zonal mean circulation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#eddy-transport-in-cesm">
     23.2.2. Eddy transport in CESM
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#vertical-levels">
     23.2.3. Vertical levels
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#further-exploration">
     23.2.4. Further exploration
    </a>
   </li>
  </ul>
 </li>
</ul>

        </nav>
        
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="atmospheric-dynamics-in-the-cesm">
<span id="nb-atmdyn"></span><h1><span class="section-number">23. </span>Atmospheric Dynamics in the CESM<a class="headerlink" href="#atmospheric-dynamics-in-the-cesm" title="Permalink to this headline">¶</a></h1>
<p>This notebook is an extension of <a class="reference external" href="https://brian-rose.github.io/ClimateLaboratoryBook">The Climate Laboratory</a> by <a class="reference external" href="http://www.atmos.albany.edu/facstaff/brose/index.html">Brian E. J. Rose</a>, University at Albany. Notebook by Rachel H. White, University of British Columbia (https://www.eoas.ubc.ca/people/rachelwhite)</p>
<p>There are ‘Discussion points’ and ‘Exercises’ throughout these notebooks. You should come to class prepared to discuss your thoughts on the Discussion points.</p>
<p>Learning goals:</p>
<ul class="simple">
<li><p>Be able to analyse atmospheric dynamics in the CESM climate model data</p></li>
<li><p>Compare the CESM model to re-analysis data (best guess of observations for most atmospheric dynamics)</p></li>
</ul>
<hr class="docutils" />
<div class="section" id="about-the-cesm">
<h2><span class="section-number">23.1. </span>About the CESM<a class="headerlink" href="#about-the-cesm" title="Permalink to this headline">¶</a></h2>
<hr class="docutils" />
<div class="section" id="key-components-of-cesm">
<h3><span class="section-number">23.1.1. </span>Key components of CESM:<a class="headerlink" href="#key-components-of-cesm" title="Permalink to this headline">¶</a></h3>
<p>see http://www.cesm.ucar.edu/models/cesm1.2/ for more info</p>
<ul class="simple">
<li><p>Atmospheric model (AGCM)</p>
<ul>
<li><p>Community Atmsophere Model (CAM)</p></li>
</ul>
</li>
<li><p>Ocean model (OGCM)</p>
<ul>
<li><p>Parallel Ocean Program (POP)</p></li>
</ul>
</li>
<li><p>Land surface model</p>
<ul>
<li><p>Community Land Model (CLM)</p></li>
</ul>
</li>
<li><p>Sea ice model</p>
<ul>
<li><p>Community Ice CodE (CICE)</p></li>
</ul>
</li>
</ul>
<p><strong>You need to be connected to the internet to run the code in this notebook</strong></p>
<p>You can browse the available data through a web interface here:</p>
<p>http://thredds.atmos.albany.edu:8080/thredds/catalog.html</p>
<p>Within this folder called <code class="docutils literal notranslate"><span class="pre">CESM</span> <span class="pre">archive</span></code>, you will find another folder called <code class="docutils literal notranslate"><span class="pre">som_input</span></code> which contains all the input files.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="large-scale-circulation-in-the-cesm">
<h2><span class="section-number">23.2. </span>Large-scale circulation in the CESM<a class="headerlink" href="#large-scale-circulation-in-the-cesm" title="Permalink to this headline">¶</a></h2>
<hr class="docutils" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">integrate</span>
<span class="kn">import</span> <span class="nn">Ngl</span>
<span class="kn">import</span> <span class="nn">cartopy</span>
<span class="kn">import</span> <span class="nn">cartopy.util</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</pre></div>
</div>
</div>
</div>
<p>We can compare the CESM model results to those in the Hartmann book we are reading (see in particular chapter 6), to see how well the CESM model reproduces observed circulation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cesm_data_path</span> <span class="o">=</span> <span class="s2">&quot;http://thredds.atmos.albany.edu:8080/thredds/dodsC/CESMA/&quot;</span>
<span class="n">cesm_input_path</span> <span class="o">=</span> <span class="n">cesm_data_path</span> <span class="o">+</span> <span class="s2">&quot;som_input/&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="zonal-mean-circulation">
<h3><span class="section-number">23.2.1. </span>Zonal mean circulation<a class="headerlink" href="#zonal-mean-circulation" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#  Let&#39;s compare the zonal mean circulation</span>
<span class="c1">#atmfile = xr.open_dataset( cesm_data_path + &#39;som_cam5/&#39; + &#39;atm/hist/&#39; + &#39;som_cam5.cam.h0.0030-12.nc&#39;)</span>
<span class="n">atmfile</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span> <span class="n">cesm_data_path</span> <span class="o">+</span> <span class="s2">&quot;cpl_1850_f19/concatenated/cpl_1850_f19.cam.h0.nc&quot;</span><span class="p">)</span>
<span class="n">atmfile</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># we want to take the zonal mean</span>
<span class="n">zmU</span> <span class="o">=</span> <span class="n">atmfile</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;lon&#39;</span><span class="p">)</span>

<span class="c1"># Now we want to take seasonal means</span>
<span class="n">zmU_seas</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">label</span><span class="p">,</span><span class="n">data</span> <span class="ow">in</span> <span class="n">zmU</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.season&#39;</span><span class="p">):</span>
    <span class="n">zmU_seas</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The groupby function (https://xarray.pydata.org/en/stable/groupby.html) is very useful for quickly separating data. Explore the output from zmU.grouby(‘time.season’), in order to understand what data is in zmU_seas,</p>
<p><strong>Discussion point:</strong> <em>Why is this not an exact seasonal climatology? (Hint: Think about weighting.)</em></p>
<p>Let’s make a plot! Remember <code class="docutils literal notranslate"><span class="pre">xarray</span></code> is able to automatically generate labeled plots. This is very handy for “quick and dirty” investigation of the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zmU_seas</span><span class="p">[</span><span class="s1">&#39;DJF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>But this is not the best way to look at zonal cross-sections. For a start, the plot is upside down, as pressure decreases with height. We can make a function to create a nicer looking plot:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_zonal_mean</span><span class="p">(</span><span class="n">plotvar</span><span class="p">,</span><span class="n">title</span><span class="p">):</span>
    <span class="c1"># We can change the size/aspect ratio of our plot</span>
    <span class="c1"># Note that these change values globally, i.e. throughout your notebook</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
    <span class="c1"># and change the default font size</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span><span class="mi">16</span><span class="p">})</span>

    <span class="c1"># Plot DJF and then JJA</span>
    <span class="k">for</span> <span class="n">seas</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;DJF&#39;</span><span class="p">,</span><span class="s1">&#39;JJA&#39;</span><span class="p">]:</span>
        <span class="c1"># use contourf to plot filled contours</span>
        <span class="c1"># set the contour levels to be plotted as an array from -70 to 70 at intervals of 5</span>
        <span class="c1"># note that to include to top value of 70, you must select a value slightly above 70</span>
        <span class="n">plotvar</span><span class="p">[</span><span class="n">seas</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">extend</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>

        <span class="c1"># change the y scale to be logarithmic</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="c1"># invert the axis so it represents height, but shows pressure</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="c1"># set the top and bottom pressure of the plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
        <span class="c1"># set the y axis tick labels</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">1000</span><span class="p">,</span><span class="mi">500</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s1">&#39;1000&#39;</span><span class="p">,</span><span class="s1">&#39;500&#39;</span><span class="p">,</span><span class="s1">&#39;200&#39;</span><span class="p">,</span><span class="s1">&#39;100&#39;</span><span class="p">,</span><span class="s1">&#39;50&#39;</span><span class="p">,</span><span class="s1">&#39;20&#39;</span><span class="p">,</span><span class="s1">&#39;10&#39;</span><span class="p">])</span>

        <span class="c1"># add a title</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">seas</span> <span class="o">+</span> <span class="s1">&#39; zonal mean zonal wind&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_zonal_mean</span><span class="p">(</span><span class="n">zmU_seas</span><span class="p">,</span><span class="s1">&#39;CESM&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## Compare to a plot created from NCER re-analysis data</span>
<span class="n">ncep_url</span> <span class="o">=</span> <span class="s2">&quot;http://www.esrl.noaa.gov/psd/thredds/dodsC/Datasets/ncep.reanalysis.derived/&quot;</span>
<span class="n">ncep_uwnd</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">ncep_url</span> <span class="o">+</span> <span class="s2">&quot;pressure/uwnd.mon.1981-2010.ltm.nc&quot;</span><span class="p">)</span>

<span class="c1"># This is already a long term mean (ltm) but we still need to calculate means for each season:</span>
<span class="n">ncep_uwnd_seas</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">ncep_uwnd_seas</span><span class="p">[</span><span class="s1">&#39;DJF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ncep_uwnd</span><span class="o">.</span><span class="n">uwnd</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">11</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;lon&#39;</span><span class="p">)</span> <span class="c1"># selecting months 0 (Jan), 1 (Feb), and 11 (Dec)</span>
<span class="n">ncep_uwnd_seas</span><span class="p">[</span><span class="s1">&#39;JJA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ncep_uwnd</span><span class="o">.</span><span class="n">uwnd</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;lon&#39;</span><span class="p">)</span> <span class="c1"># selecting months 5 (Jun), 6 (Jul), and 7 (Aug)</span>

<span class="n">plot_zonal_mean</span><span class="p">(</span><span class="n">ncep_uwnd_seas</span><span class="p">,</span><span class="s1">&#39;NCEP reanalysis&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>When completing model evaluation like this, it is often useful to plot both the model and the re-analysis or observations on the same plot, so you can better evaluate model biases. Even better is to plot the model bias itself, but this involves re-gridding the datasets to be on the same grid (same latitudes, longitudes and pressure levels).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_zonal_mean_comp</span><span class="p">(</span><span class="n">plotvarmodel</span><span class="p">,</span><span class="n">plotvarNCEP</span><span class="p">,</span><span class="n">title</span><span class="p">):</span>
    <span class="c1"># We can change the size/aspect ratio of our plot</span>
    <span class="c1"># Note that these change values globally, i.e. throughout your notebook</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
    <span class="c1"># and change the default font size</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span><span class="mi">16</span><span class="p">})</span>

    <span class="c1"># Plot DJF and then JJA</span>
    <span class="k">for</span> <span class="n">seas</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;DJF&#39;</span><span class="p">,</span><span class="s1">&#39;JJA&#39;</span><span class="p">]:</span>
        <span class="c1"># use contourf to plot filled contours</span>
        <span class="c1"># set the contour levels to be plotted as an array from -70 to 70 at intervals of 5</span>
        <span class="c1"># note that to include to top value of 70, you must select a value slightly above 70</span>
        <span class="n">plotvarmodel</span><span class="p">[</span><span class="n">seas</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">extend</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
        <span class="n">plotvarmodel</span><span class="p">[</span><span class="n">seas</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">extend</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">)</span>


        <span class="n">plotvarNCEP</span><span class="p">[</span><span class="n">seas</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">extend</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

        <span class="c1"># change the y scale to be logarithmic</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="c1"># invert the axis so it represents height, but shows pressure</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="c1"># set the top and bottom pressure of the plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
        <span class="c1"># set the y axis tick labels</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">1000</span><span class="p">,</span><span class="mi">500</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s1">&#39;1000&#39;</span><span class="p">,</span><span class="s1">&#39;500&#39;</span><span class="p">,</span><span class="s1">&#39;200&#39;</span><span class="p">,</span><span class="s1">&#39;100&#39;</span><span class="p">,</span><span class="s1">&#39;50&#39;</span><span class="p">,</span><span class="s1">&#39;20&#39;</span><span class="p">,</span><span class="s1">&#39;10&#39;</span><span class="p">])</span>

        <span class="c1"># add a title</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">seas</span> <span class="o">+</span> <span class="s1">&#39; zonal mean zonal wind&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_zonal_mean_comp</span><span class="p">(</span><span class="n">zmU_seas</span><span class="p">,</span><span class="n">ncep_uwnd_seas</span><span class="p">,</span><span class="s1">&#39;CESM and NCEP&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Discussion point:</strong> <em>Compare the model to the re-analysis “observations”. How well does the model do? What might affect the model results - think about what we know about the experiment cpl_1850_f19 from before.</em></p>
<p><strong>Extra exercise:</strong> try calculating an exact seasonal mean, and compare the differences.</p>
<p>Now let’s look at the meridional mass streamfunction, as in figure 6.5 in the Hartmann book. This is a measure of the strength of the meridional overturning circulation. Meridional mass streamfunction isn’t an output of the model. So we need to calculate it.
Similar to matlab, if there is a variable you want to calculate, it is likely someone has already made a package
that calculate it. In this case we can use a function from the TropD package: https://tropd.github.io/pytropd/index.html
This function is shown below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">TropD_Calculate_StreamFunction</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lev</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Calculate streamfunction by integrating meridional wind from top of the atmosphere to surface</span>

<span class="sd">      Args:</span>

<span class="sd">        V: array of zonal-mean meridional wind with dimensions (lat, lev)</span>
<span class="sd">      </span>
<span class="sd">        lat: equally spaced latitude array</span>

<span class="sd">        lev: vertical level array in hPa</span>

<span class="sd">      Returns:</span>
<span class="sd">  </span>
<span class="sd">        ndarray: the streamfunction psi(lat,lev) </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">EarthRadius</span> <span class="o">=</span> <span class="mf">6371220.0</span>
    <span class="n">EarthGrav</span> <span class="o">=</span> <span class="mf">9.80616</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">V</span><span class="p">))</span> 
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">V</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># edited RHW</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>

    <span class="c1"># RHW edit: use tile to repeat cos(lat) len(lev) times, rather than repeat and then reshape</span>
    <span class="n">COS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">),[</span><span class="nb">len</span><span class="p">(</span><span class="n">lev</span><span class="p">),</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="p">(</span><span class="n">EarthRadius</span><span class="o">/</span><span class="n">EarthGrav</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> \
         <span class="o">*</span> <span class="n">sp</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">cumtrapz</span><span class="p">(</span><span class="n">B</span> <span class="o">*</span> <span class="n">V</span> <span class="o">*</span> <span class="n">COS</span><span class="p">,</span> <span class="n">lev</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> 
  
    <span class="k">return</span> <span class="n">psi</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># We need seasonal mean, zonal mean, meridional wind</span>
<span class="n">zmV</span> <span class="o">=</span> <span class="n">atmfile</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;lon&#39;</span><span class="p">)</span>

<span class="c1"># Now we want to take seasonal means</span>
<span class="n">zmV_seas</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">label</span><span class="p">,</span><span class="n">data</span> <span class="ow">in</span> <span class="n">zmV</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.season&#39;</span><span class="p">):</span>
    <span class="n">zmV_seas</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

<span class="c1"># Calculate mean meridional mass streamfunction on seasonal means:</span>
<span class="n">psi_cesm</span><span class="o">=</span><span class="p">{}</span>
<span class="k">for</span> <span class="n">iseas</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;DJF&#39;</span><span class="p">,</span><span class="s1">&#39;JJA&#39;</span><span class="p">]:</span>
    <span class="n">psi_cesm</span><span class="p">[</span><span class="n">iseas</span><span class="p">]</span> <span class="o">=</span> <span class="n">TropD_Calculate_StreamFunction</span><span class="p">(</span><span class="n">zmV_seas</span><span class="p">[</span><span class="n">iseas</span><span class="p">],</span> <span class="n">zmV_seas</span><span class="p">[</span><span class="n">iseas</span><span class="p">]</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">zmV_seas</span><span class="p">[</span><span class="n">iseas</span><span class="p">]</span><span class="o">.</span><span class="n">lev</span><span class="p">)</span>

<span class="c1"># now add the annual mean:</span>
<span class="n">psi_cesm</span><span class="p">[</span><span class="s1">&#39;ANN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TropD_Calculate_StreamFunction</span><span class="p">(</span><span class="n">zmV</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">zmV</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">zmV</span><span class="o">.</span><span class="n">lev</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The output from TropD_Calculate_StreamFunction is a numpy array, not an xarray - this is often the case for functions from downloaded packages - so we have two options:</p>
<ol class="simple">
<li><p>turn it into an xarray since we know the coordinate and dimensions.
or 2. plot by hand since we’re going to have to adjust the plot anyway.
For now, here’s option 2:</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span><span class="mi">16</span><span class="p">})</span>

<span class="k">for</span> <span class="n">iseas</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;DJF&#39;</span><span class="p">,</span><span class="s1">&#39;JJA&#39;</span><span class="p">,</span><span class="s1">&#39;ANN&#39;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">zmV</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">zmV</span><span class="o">.</span><span class="n">lev</span><span class="p">,</span><span class="n">psi_cesm</span><span class="p">[</span><span class="n">iseas</span><span class="p">],</span><span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">20E10</span><span class="p">,</span><span class="mf">21E10</span><span class="p">,</span><span class="mf">2E10</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">zmV</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">zmV</span><span class="o">.</span><span class="n">lev</span><span class="p">,</span><span class="n">psi_cesm</span><span class="p">[</span><span class="n">iseas</span><span class="p">],</span><span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">20E10</span><span class="p">,</span><span class="mf">21E10</span><span class="p">,</span><span class="mf">2E10</span><span class="p">),</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">,</span><span class="n">linewidths</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Exercise:</strong> <em>Alter this code to improve this figure. Access the NCEP v field, calculate meridional streamfunction, and add in the NCEP meridional overturning streamfunction to this plot.</em></p>
<p><strong>Discussion point:</strong> <em>How well does the model do in comparison with the observations?</em></p>
<p>For those of you interested in creating xarrays. See https://xarray.pydata.org/en/stable/data-structures.html for  more detail, and the basics are shown below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># First let&#39;s combine the seasons into a single np array, the first dimension will be season with our</span>
<span class="c1"># 3 &#39;seasons&#39; of interest: &#39;DJF&#39;,&#39;JJA&#39;,&#39;ANN&#39;</span>
<span class="n">psi_cesm_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">zmV</span><span class="o">.</span><span class="n">lev</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">zmV</span><span class="o">.</span><span class="n">lat</span><span class="p">)])</span>
<span class="c1"># now fill with the values: note we now need to remember what index we use for each season here - we will add this</span>
<span class="c1"># information back in later, so we store it in seas_array</span>
<span class="n">index</span><span class="o">=</span><span class="mi">0</span>
<span class="n">seas_array</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DJF&#39;</span><span class="p">,</span><span class="s1">&#39;JJA&#39;</span><span class="p">,</span><span class="s1">&#39;ANN&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">iseas</span> <span class="ow">in</span> <span class="n">seas_array</span><span class="p">:</span>
    <span class="n">psi_cesm_array</span><span class="p">[</span><span class="n">index</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">psi_cesm</span><span class="p">[</span><span class="n">iseas</span><span class="p">];</span> <span class="n">index</span><span class="o">+=</span><span class="mi">1</span> <span class="c1"># this increments index by 1</span>
    
<span class="n">psi_cesm_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">psi_cesm_array</span><span class="p">,</span>
                          <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;lev&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span>
                          <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="n">seas_array</span><span class="p">,</span><span class="s1">&#39;lev&#39;</span><span class="p">:</span><span class="n">zmV</span><span class="o">.</span><span class="n">lev</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">:</span><span class="n">zmV</span><span class="o">.</span><span class="n">lat</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Exercise:</strong> <em>Alter the code below to check this dataarray gives the same results as before.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check this dataarray gives the same results as before</span>
<span class="n">psi_cesm_xr</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s1">&#39;ANN&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">contour</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="eddy-transport-in-cesm">
<h3><span class="section-number">23.2.2. </span>Eddy transport in CESM<a class="headerlink" href="#eddy-transport-in-cesm" title="Permalink to this headline">¶</a></h3>
<p>Moving away from zonal means, we can look at eddy transports. We can calculate the total vT from the model output:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vT</span> <span class="o">=</span> <span class="p">(</span><span class="n">atmfile</span><span class="o">.</span><span class="n">V</span> <span class="o">*</span> <span class="n">atmfile</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;lon&#39;</span><span class="p">)</span>

<span class="c1"># estimate the seasonal climatology</span>
<span class="n">zmVT_seas</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">zmV_seas</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">zmT_seas</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">label</span><span class="p">,</span><span class="n">data</span> <span class="ow">in</span> <span class="n">vT</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.season&#39;</span><span class="p">):</span>
    <span class="n">zmVT_seas</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">label</span><span class="p">,</span><span class="n">data</span> <span class="ow">in</span> <span class="n">atmfile</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.season&#39;</span><span class="p">):</span>
    <span class="n">zmV_seas</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">label</span><span class="p">,</span><span class="n">data</span> <span class="ow">in</span> <span class="n">atmfile</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.season&#39;</span><span class="p">):</span>
    <span class="n">zmT_seas</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Exercise:</strong> Now calculate and plot v<em>T</em> + v’T’ as per equation 6.13 (Hartmann) to compare with figure 6.9 (Hartmann).</p>
<p><strong>Discussion point:</strong> <em>How does the CESM model eddy transport compare to the “observed” values shown in Fig. 6.9? Think about the time resolution of the CESM model output (you may need to print/explore atmfields to remind yourself of this), and why this method of calculating vT could underestimate meridional heat transport.</em></p>
<p>Models such as CESM actually have variables such as <span class="math notranslate nohighlight">\(\overline{vT}\)</span> as an output. This is an average over each timestep of vT and therefore provides a more accurate estimate of true vT than calculating it “offline” (i.e. after the model has run) without having to output variables on every timestep, which would take up too much space.</p>
<p><strong>Exercise</strong> <em>Find the vT field in atmfile, and then calculate and plot v’T’ + v<em>T</em> using vT directly from the model. Compare to the observations and our previous plot.</em></p>
<p><strong>Exercise</strong> <em>Explore the model and plot some other meridional transports, comparing the model calculated values with those calcualted offline</em></p>
</div>
<div class="section" id="vertical-levels">
<h3><span class="section-number">23.2.3. </span>Vertical levels<a class="headerlink" href="#vertical-levels" title="Permalink to this headline">¶</a></h3>
<p>Look at the y-axis in our first plot of zonal mean zonal wind. Notice that the variable is not ‘pressure’, it’s ‘hybrid level at midpoints’. If you explore the dimension ‘lev’ in atmfile you find the units are ‘level’ and the standard name is: ‘atmosphere_hybrid_sigma_pressure_coordinate’.  The CESM model default outputs are on model levels, which are not isobaric surfaces. This version of the CESM uses what’s known as a hybrid vertical co-ordinate: near the surface, the levels follow the terrain, often known as a ‘sigma’ co-ordinate; this makes calculation of the dynamics near the surface simpler. At the top of the model, the levels are isobaric surfaces; in between they are a hybrid, or “sigma-pressure’. This is illustrated in the schematic below.</p>
<img alt="../_images/Fig_hyb_coord.jpg" src="../_images/Fig_hyb_coord.jpg" />
<blockquote>
<div><p>Figure | The hybrid sigma-pressure co-ordinates in this version of the CESM model.</p>
</div></blockquote>
<p>For more accurate plotting we need to convert the data from these model co-ordinates onto pressure levels, by using the identity p(t,k,j,i) = a(k)*p0 + b(k)*ps(t,j,i), where a and b are parameters (functions of level only). Handily NCAR (the developers of the CESM model) have built functions to do this for us, originally in NCL (the NCAR Command Language) and now in python (https://www.pyngl.ucar.edu/Functions/Ngl.vinth2p.shtml).</p>
<p>This can take quite some time to run, particularly if you want to convert monthly or daily data onto pressure levels. Ideally this should be written as a separate function and run outside of your notebooks, but we will do this once here as an example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># the parameters hyam and hybm are parameters used to calculate the pressure from the level value</span>
<span class="n">hyam</span> <span class="o">=</span> <span class="n">atmfile</span><span class="p">[</span><span class="s1">&#39;hyam&#39;</span><span class="p">]</span>
<span class="n">hybm</span> <span class="o">=</span> <span class="n">atmfile</span><span class="p">[</span><span class="s1">&#39;hybm&#39;</span><span class="p">]</span>
<span class="n">T</span>    <span class="o">=</span> <span class="n">atmfile</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">psfc</span> <span class="o">=</span> <span class="n">atmfile</span><span class="p">[</span><span class="s1">&#39;PS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">atmfile</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">p0mb</span> <span class="o">=</span> <span class="n">atmfile</span><span class="p">[</span><span class="s1">&#39;P0&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">100.0</span>

<span class="c1"># Selection of the pressure levels you would like the data on </span>
<span class="c1"># if you are plotting with log pressure as the vertical coodinate it is good to space yourlevels to be at least </span>
<span class="c1"># approximately equally space in log-pressure coordinates.</span>
<span class="n">pnew</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1000.</span><span class="p">,</span><span class="mf">850.</span><span class="p">,</span><span class="mf">700.</span><span class="p">,</span><span class="mf">600.</span><span class="p">,</span><span class="mf">500.</span><span class="p">,</span><span class="mf">400.</span><span class="p">,</span><span class="mf">300.</span><span class="p">,</span><span class="mf">250.</span><span class="p">,</span><span class="mf">200.</span><span class="p">,</span><span class="mf">150.</span><span class="p">,</span><span class="mf">100.</span><span class="p">,</span><span class="mf">70.</span><span class="p">,</span><span class="mf">50.</span><span class="p">,</span><span class="mf">30.</span><span class="p">,</span><span class="mf">20.</span><span class="p">,</span><span class="mf">10.</span><span class="p">,</span><span class="mf">5.</span><span class="p">]</span>

<span class="n">Upres</span> <span class="o">=</span> <span class="n">Ngl</span><span class="o">.</span><span class="n">vinth2p</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">hyam</span><span class="p">,</span> <span class="n">hybm</span><span class="p">,</span> <span class="n">pnew</span><span class="p">,</span> <span class="n">psfc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p0mb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="c1"># This has set values below the surface to 1E30. We want these to be nan:</span>
<span class="n">Upres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Upres</span><span class="o">&gt;=</span><span class="mf">1E30</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="n">Upres</span><span class="p">)</span>

<span class="c1"># Create xarray from this numpy ndarray:</span>
<span class="n">Upres_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">Upres</span><span class="p">,</span>
                          <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;plev&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span>
                          <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;plev&#39;</span><span class="p">:</span><span class="n">pnew</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">:</span><span class="n">U</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">:</span><span class="n">U</span><span class="o">.</span><span class="n">lon</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Now compare this to the annual mean on hybrid levels</span>
<span class="n">U</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;lon&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">extend</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
<span class="c1"># Add in black contours, also at 5m/s intervals. Note plot.contour automatically plots</span>
<span class="c1"># negative contours as dashed</span>
<span class="n">U</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;lon&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">extend</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

<span class="c1"># change the y scale to be logarithmic</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span> 
<span class="c1"># invert the axis so it represents height, but shows pressure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="c1"># set the top and bottom pressure of the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="c1"># set the y axis tick labels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">1000</span><span class="p">,</span><span class="mi">500</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s1">&#39;1000&#39;</span><span class="p">,</span><span class="s1">&#39;500&#39;</span><span class="p">,</span><span class="s1">&#39;200&#39;</span><span class="p">,</span><span class="s1">&#39;100&#39;</span><span class="p">,</span><span class="s1">&#39;50&#39;</span><span class="p">,</span><span class="s1">&#39;20&#39;</span><span class="p">,</span><span class="s1">&#39;10&#39;</span><span class="p">])</span>

<span class="c1"># add a title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Annual mean zonal mean zonal wind: hybrid levels&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">Upres_xr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;lon&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">extend</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
<span class="c1"># Add in black contours, also at 5m/s intervals. Note plot.contour automatically plots</span>
<span class="c1"># negative contours as dashed</span>
<span class="n">Upres_xr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;lon&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">extend</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

<span class="c1"># change the y scale to be logarithmic</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span> 
<span class="c1"># invert the axis so it represents height, but shows pressure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="c1"># set the top and bottom pressure of the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="c1"># set the y axis tick labels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">1000</span><span class="p">,</span><span class="mi">500</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s1">&#39;1000&#39;</span><span class="p">,</span><span class="s1">&#39;500&#39;</span><span class="p">,</span><span class="s1">&#39;200&#39;</span><span class="p">,</span><span class="s1">&#39;100&#39;</span><span class="p">,</span><span class="s1">&#39;50&#39;</span><span class="p">,</span><span class="s1">&#39;20&#39;</span><span class="p">,</span><span class="s1">&#39;10&#39;</span><span class="p">])</span>

<span class="c1"># add a title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Annual mean zonal mean zonal wind: pressure levels&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Differences are minor, except close to the surface, as expected as this is where the model levels are least similar to pressure levels. We can now also plot maps of the winds on pressure surfaces, such as the upper-level jets.
It is useful to define generic functions for sets of operations you will use repeatedly, e.g.:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allow for a range of map projections</span>
<span class="c1"># set directory where map data is downloaded</span>
<span class="n">cartopy</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;../data/&#39;</span>

<span class="k">def</span> <span class="nf">set_proj</span><span class="p">(</span><span class="n">projection</span><span class="p">,</span><span class="n">nrows</span><span class="p">,</span><span class="n">ncols</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;Ortho&#39;</span><span class="p">:</span>
        <span class="n">proj</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Orthographic</span><span class="p">(</span><span class="n">central_latitude</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;Mollweide&#39;</span><span class="p">:</span>
        <span class="n">proj</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Mollweide</span><span class="p">(</span><span class="n">central_longitude</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;NorthPole&#39;</span><span class="p">:</span>
        <span class="n">proj</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">NorthPolarStereo</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;PlateCarree&#39;</span><span class="p">:</span>
        <span class="n">proj</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;Robinson&#39;</span><span class="p">:</span>
        <span class="n">proj</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Robinson</span><span class="p">()</span>
        

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">ncols</span><span class="p">,</span><span class="n">nrows</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">projection</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span>
    <span class="c1"># Draw land map</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="c1"># draw gridlines</span>
    <span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>

    <span class="c1"># Define where gridlines are for some map projections:    </span>
    <span class="k">if</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;PlateCarree&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="o">-</span><span class="mi">150</span><span class="p">,</span><span class="o">-</span><span class="mi">120</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span><span class="mi">150</span><span class="p">,</span> <span class="mi">180</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">,</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">90</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>


    <span class="k">return</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">plot_map</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span><span class="n">toplot</span><span class="p">,</span><span class="n">levels</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">nrows</span><span class="p">,</span><span class="n">ncols</span><span class="p">,</span><span class="n">title</span><span class="p">):</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="mi">6</span><span class="o">*</span><span class="n">nrows</span><span class="p">)</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span><span class="mi">16</span><span class="p">})</span>
    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">set_proj</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span><span class="n">ncols</span><span class="p">,</span><span class="n">nrows</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    
    <span class="c1"># Add cyclic point so there isn&#39;t a gap in the data.</span>
    <span class="n">coord</span> <span class="o">=</span> <span class="s1">&#39;lon&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">lon_idx</span> <span class="o">=</span> <span class="n">toplot</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="s1">&#39;longitude&#39;</span>
        <span class="n">lon_idx</span> <span class="o">=</span> <span class="n">toplot</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
        
    <span class="n">cyclic_data</span><span class="p">,</span> <span class="n">cyclic_coord</span> <span class="o">=</span> <span class="n">cartopy</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">add_cyclic_point</span><span class="p">(</span><span class="n">toplot</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                 <span class="n">coord</span><span class="o">=</span><span class="n">toplot</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">coord</span><span class="p">],</span>
                                                 <span class="n">axis</span><span class="o">=</span><span class="n">lon_idx</span><span class="p">)</span>
    
    <span class="n">cp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">cyclic_coord</span><span class="p">,</span><span class="n">toplot</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span><span class="n">cyclic_data</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span><span class="n">extend</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span>
                      <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>

    <span class="c1"># Add colorbar</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">proj</span> <span class="o">+</span> <span class="s1">&#39; projection&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># We can plot different projections too, as subplots on one main plot</span>
<span class="n">plev</span><span class="o">=</span><span class="mi">250</span>

<span class="n">toplot</span> <span class="o">=</span> <span class="n">Upres_xr</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">plev</span><span class="o">=</span><span class="n">plev</span><span class="p">)</span>

<span class="n">n</span><span class="o">=</span><span class="mi">1</span>
<span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Annual mean zonal wind at &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">plev</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;mb;&#39;</span>
<span class="k">for</span> <span class="n">projection</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Robinson&#39;</span><span class="p">,</span><span class="s1">&#39;Mollweide&#39;</span><span class="p">,</span><span class="s1">&#39;Ortho&#39;</span><span class="p">,</span><span class="s1">&#39;PlateCarree&#39;</span><span class="p">]:</span>
    <span class="n">plot_map</span><span class="p">(</span><span class="n">projection</span><span class="p">,</span><span class="n">toplot</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span><span class="mi">51</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">title</span><span class="p">);</span> <span class="n">n</span><span class="o">+=</span><span class="mi">1</span>                      

<span class="c1"># Add in black contours, also at 5m/s intervals. Note plot.contour automatically plots</span>
<span class="c1"># negative contours as dashed</span>

<span class="c1"># add a title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="further-exploration">
<h3><span class="section-number">23.2.4. </span>Further exploration<a class="headerlink" href="#further-exploration" title="Permalink to this headline">¶</a></h3>
<p><strong>Exercise:</strong> <em>Explore the model data and create plots to help you understand more about the atmospheric circulation. Come to class prepared to share one of these plots and discuss what it shows you.</em></p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./courseware"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="seasonal-cycle.html" title="previous page"><span class="section-number">22. </span>Modeling the seasonal cycle of surface temperature</a>
    <a class='right-next' id="next-link" href="numerical-diffusion.html" title="next page"><span class="section-number">24. </span>A peek at numerical methods for diffusion models</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Brian Rose<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.d3f166471bb80abb5163.js"></script>


    
  </body>
</html>